<!DOCTYPE html>
<html lang='en'>
  <head>
    <title>Deploying your static site with Travis CI - Rowan Hogan dot com.</title>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='Full-stack designer from Brisbane, Australia.' name='description'>
    <meta content='width=device-width, minimal-ui' name='viewport'>
    <link href="../../assets/images/favicon.ico" rel="icon" type="image/ico" />
    <link href="../../assets/stylesheets/application-051ee260.css" rel="stylesheet" />
    <link href="../../assets/stylesheets/print-ecddfe38.css" rel="stylesheet" media="print" />
    <script src="//use.typekit.net/arj3ujg.js"></script>
    <script>
      try{Typekit.load();}catch(e){}
    </script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body class='articles articles_deploying-your-static-site-with-travis-ci articles_deploying-your-static-site-with-travis-ci_index'>
    <header class='site-header'>
      <div class='container'>
        <a class="logo" href="/"><svg style='enable-background:new -82.8 0 290.3 512;' viewBox='-82.8 0 290.3 512' width='30' x='0px' y='0px'>
          <g>
            <path d='M174.7,189.1c-5.5-5.9-11.8-11-18.7-15.5l-67,67c7.4,3.5,14.1,8.6,19.3,15.9c6.8,9.6,11.1,22.9,11.1,40.6v215l87.9-87.7&#x000A;		V284.2C207.3,245.3,196.2,212,174.7,189.1z'></path>
            <path d='M89.6,155.7c-6.1,0-12.2,0.6-18.2,1.6L-82.8,311.5v37.1L108.8,157C102.7,156.2,96.3,155.7,89.6,155.7z'></path>
            <polygon points='5.1,159.7 5.1,0.7 -82.8,88.4 -82.8,159.7 -31.9,159.7 -82.8,210.6 -82.8,247.7 5.1,159.8 	'></polygon>
            <polygon points='-44.4,512 5.1,462.5 5.1,425.3 -81.5,512 	'></polygon>
            <polygon points='-82.8,449.5 5.1,361.6 5.1,324.4 -82.8,412.3 	'></polygon>
          </g>
        </svg>
        </a>
        <nav class='site-nav'>
          <a href="/feed">Feed</a>
          <a href="/projects">Projects</a>
          <a class="active" href="/articles">Articles</a>
          <a href="/resume">R&eacute;sum&eacute;</a>
        </nav>
      </div>
    </header>
    <section class='site-main'>
      <div class='container'>
        <h1>Deploying your static site with Travis CI</h1>
        <em class='date'>Thursday, 14 May 2015</em>
        <section class='article-body'>
          <p>So I know I just wrote <a href="/blog/simple-static-sites">a post</a> about deploying your sites with <a href="https://www.netlify.com/">Netlify</a>, but this very website uses <a href="https://travis-ci.org/">Travis CI</a> for continuous deployment. There was just one minor issue that was preventing the CI/CD process running smoothly&hellip; Any Pull Requests submitted to <code>master</code> were deployed just the same as a commit directly to master.</p>
          
          <p>At first I thought it was an issue with the configuration. <em>Travis</em> allows you to specify branches to run on, e.g.</p>
          <pre class="highlight plaintext"><code>branches:
            only:
              - master
          
          script:
            - 'bundle exec middleman build &amp;&amp; bundle exec middleman deploy' # etc.
          </code></pre>
          
          <p>So, great, it should only run on master. If you push a bunch of commits to say <code>my_new_feature</code> branch, no builds from <em>Travis</em>. Pull requests are treated a little differently though, when you submit a PR to merge that branch into master, it runs the build no matter what branch it came from.</p>
          
          <p>Now this actually makes sense: test that the new feature branch is A-OK, so that it can be merged into master. The problem is we were running the deploy script on a successful build, so for this website it would, for example, publish a perfectly &lsquo;valid&rsquo; blog post, even if it hadn&rsquo;t been proofread. It was arguably a little too ambitious with the <em>Continuous</em> part of <a href="http://en.wikipedia.org/wiki/Continuous_delivery">Continuous Delivery</a>.</p>
          
          <p>So, we&rsquo;ve made some changes to the <em>Travis</em> setup. We&rsquo;ve now removed the deploying element from the script, and separated it:</p>
          <pre class="highlight plaintext"><code>script:
            - 'npm install -g bower'
            - 'bower install -f'
            - 'bundle exec middleman build'
          </code></pre>
          
          <p>This tests that everything is OK with the build process, and if it succeeds&hellip;</p>
          <pre class="highlight plaintext"><code>after_success:
            - './deploy.sh'
          </code></pre>
          
          <p>Which runs the following in <code>deploy.sh</code></p>
          <pre class="highlight shell"><code><span class="c">#!/bin/bash</span>
          
          <span class="k">if</span> <span class="o">([</span> <span class="nv">$TRAVIS_BRANCH</span> <span class="o">==</span> <span class="s2">"master"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$TRAVIS_PULL_REQUEST</span> <span class="o">==</span> <span class="s2">"false"</span> <span class="o">])</span>
          <span class="k">then
            </span>bundle <span class="nb">exec </span>middleman s3_sync
            <span class="nb">echo</span> <span class="s1">'Website published successfully.'</span>
          <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"Build successful, but not publishing!"</span>
          <span class="k">fi</span>
          </code></pre>
          
          <p>We&rsquo;ve moved the deploy script code into a separate bash file to get around syntax errors in YAML (though you can write the same bash inside your <code>travis.yml</code>, you just have to escape it).</p>
          
          <p><img alt="Travis build..." src="http://netengine-blog-media.s3.amazonaws.com/simple_static_sites/travis.png" /></p>
          
          <p style="text-align: center; font-size: 1.25em;"><strong>Huzzah!</strong> <img src="http://netengine-blog-media.s3.amazonaws.com/simple_static_sites/fireworks-animated.gif" style="display: inline-block; margin: 1em .5em; height: 3em; vertical-align: middle; box-shadow: none;"></p>
          
          <p>The end process is as follows:</p>
          
          <ul>
          <li>Any direct commit to <code>master</code> runs the build and deploys if successful.</li>
          <li>A Pull Request to be merged to <code>master</code> runs the build but doesnâ€™t deploy.</li>
          <li>A merged PR commit runs the build and deploys if successful (acts as normal commit to <code>master</code>).</li>
          </ul>
          
          <p>Happy Continuous Delivering :)</p>
          
          <p><em>Originally published on <a href="http://netengine.com.au/blog/deploying-your-static-site-with-travis-ci/">netengine.com.au</a></em></p>
          
          <p><link rel="canonical" href="http://netengine.com.au/blog/deploying-your-static-site-with-travis-ci/"></p>
        </section>
        <footer class='blog-post-footer'>
          <a class="prev" href="/articles/simple-static-sites/">Prev</a>
          <a href="/articles">See all posts</a>
          <a class="next" href="/articles/new-monogram-design/">Next</a>
        </footer>
      </div>
    </section>
    <footer class='site-footer'>
      <div class='container'>
        <nav class='site-nav'>
          <a class="github" href="https://github.com/rowanhogan">GitHub</a>
          <a class="dribbble" href="http://dribbble.com/rowanhogan">Dribbble</a>
          <a class="linkedin" href="http://www.linkedin.com/in/rowanhogan">LinkedIn</a>
          <a class="twitter" href="https://twitter.com/rowanhogan">Twitter</a>
          <a class="lastfm" href="http://www.last.fm/user/rehogan">Last.fm</a>
        </nav>
      </div>
    </footer>
    <script src="../../assets/javascripts/application-aedf1007.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-42849478-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
